<!DOCTYPE html>
<html lang="hu">

<head>
  <title>√Åtj√°tsz√≥/Papag√°j Frekvenci√°k T√©rk√©pe - Magyarorsz√°g</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #1a202c;
      --bg-secondary: #2d3748;
      --text-primary: #ffffff;
      --text-secondary: #cbd5e0;
      --border-color: #4a5568;
      --input-bg: rgba(45, 55, 72, 0.95);
      --popup-bg: #2d3748;
    }

    [data-theme="light"] {
      --bg-primary: #f7fafc;
      --bg-secondary: rgba(255, 255, 255, 0.95);
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --border-color: #e2e8f0;
      --input-bg: rgba(255, 255, 255, 0.95);
      --popup-bg: #ffffff;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .header {
      background: var(--bg-secondary);
      backdrop-filter: blur(10px);
      padding: 6px 0 6px 0;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 1000;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .header h1 {
      color: var(--text-primary);
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 2px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .header p {
      color: var(--text-secondary);
      font-size: 0.75rem;
      font-weight: 300;
      margin-bottom: 4px;
    }

    .search-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
    }

    #searchInput {
      width: 250px;
      padding: 7px 14px;
      border: none;
      border-radius: 20px;
      font-size: 0.9rem;
      background: var(--input-bg);
      color: var(--text-primary);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
    }

    #searchInput::placeholder {
      color: #a0aec0;
    }

    #searchInput:focus {
      outline: none;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      transform: translateY(-2px);
      border-color: #63b3ed;
    }

    #clearSearch {
      background: linear-gradient(135deg, #e53e3e, #c53030);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      display: none;
    }

    #clearSearch:hover {
      transform: scale(1.1);
    }

    #themeToggle {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    #themeToggle:hover {
      transform: scale(1.1);
    }

    #mapToggle {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    #mapToggle:hover {
      transform: scale(1.1);
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 8px;
    }

    .stat-item {
      background: linear-gradient(135deg, #3182ce, #2c5282);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      border: 1px solid #4a5568;
    }

    #map {
      height: calc(100vh - 100px);
      width: 100%;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .custom-popup {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 20px;
      min-width: 280px;
      background: var(--popup-bg);
      color: var(--text-secondary);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border-color);
    }

    .custom-popup h3 {
      color: var(--text-primary);
      margin-bottom: 10px;
      font-size: 1.3rem;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    .custom-popup p {
      color: var(--text-secondary);
      font-size: 1rem;
      margin: 8px 0;
      padding: 5px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .custom-popup p:last-child {
      border-bottom: none;
    }

    .custom-popup strong {
      color: #63b3ed;
      font-weight: 600;
    }

    /* Marker anim√°ci√≥k */
    .custom-marker {
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }

    .custom-marker:hover {
      transform: scale(1.2);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      50% {
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
      }

      100% {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
    }

    /* Hat√°rok r√©teg st√≠lus */
    .boundaries-layer {
      opacity: 0.7;
      mix-blend-mode: overlay;
    }

    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: var(--bg-secondary);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      font-size: 0.9rem;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .legend h4 {
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    @media (max-width: 768px) {
      .header {
        padding: 8px 10px;
      }

      .header h1 {
        font-size: 1.1rem;
      }

      .header p {
        font-size: 0.75rem;
        margin-bottom: 8px;
      }

      #searchInput {
        width: calc(100vw - 80px);
        max-width: 300px;
        font-size: 0.9rem;
        padding: 12px 16px;
      }

      .search-container {
        margin: 8px 0;
        padding: 0 10px;
      }

      .stats {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        padding: 0 10px;
      }

      .stat-item {
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      .legend {
        bottom: 10px;
        right: 10px;
        left: 10px;
        font-size: 0.75rem;
        padding: 12px;
      }

      #map {
        height: calc(100vh - 120px);
      }

      #locateMeBtn {
        right: 15px;
        bottom: calc(15px + 140px);
        width: 44px;
        height: 44px;
      }

      #locateMeBtn svg {
        width: 40px;
        height: 40px;
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1rem;
      }

      .header p {
        font-size: 0.7rem;
      }

      #searchInput {
        width: calc(100vw - 60px);
        padding: 10px 14px;
        font-size: 0.85rem;
      }

      .stats {
        gap: 6px;
      }

      .stat-item {
        padding: 6px 10px;
        font-size: 0.75rem;
      }

      .legend {
        font-size: 0.7rem;
        padding: 10px;
      }

      .custom-popup {
        min-width: 250px;
        padding: 15px;
      }

      .custom-popup h3 {
        font-size: 1.1rem;
      }

      .custom-popup p {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>ü¶ú √Åtj√°tsz√≥/Papag√°j Frekvenci√°k</h1>
    <p>Magyarorsz√°gi √°tj√°tsz√≥ √©s papag√°j frekvenci√°k, csatorn√°k, CTCSS k√≥dok √©s ad√≥√°llom√°sok</p>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="üîç Keres√©s telep√ºl√©s, frekvencia vagy csatorna szerint..." />
      <button id="clearSearch">‚ùå</button>
      <button id="themeToggle" title="T√©ma v√°lt√°sa">üåô</button>
      <button id="mapToggle" title="T√©rk√©p t√≠pus v√°lt√°sa">üó∫Ô∏è</button>
    </div>

    <div class="stats">
      <div class="stat-item">ü¶ú 25 csatorna</div>
      <div class="stat-item">üîä CTCSS k√≥dok</div>
      <div class="stat-item">üì± Reszponz√≠v</div>
    </div>
  </div>

  <div id="map"></div>

  <div class="legend">
    <h4>ü¶ú Jelmagyar√°zat</h4>
    <div class="legend-item">
      <div class="legend-color"></div>
      <span>√Åtj√°tsz√≥/Papag√°j csatorna</span>
    </div>
    <div style="margin-top: 10px; font-size: 0.8rem; color: #7f8c8d;">
      Kattints a jelre a frekvencia √©s csatorna adatok megjelen√≠t√©s√©hez
    </div>
    <div style="margin-top: 8px; font-size: 0.75rem; color: #e53e3e; border-top: 1px solid var(--border-color); padding-top: 8px;">
      ‚ö†Ô∏è Figyelem: A t√©rk√©p koordin√°t√°i k√∂r√ºlbel√ºli helyeket mutatnak, nem mindig pontosak!
    </div>
  </div>

  <!-- T√°vols√°g panel -->
  <div id="distancePanel" class="legend" style="bottom: 20px; left: 20px; right: auto; max-width: 300px; display: none;">
    <h4>üìè Legk√∂zelebbi csatorn√°k</h4>
    <div id="distanceList"></div>
  </div>

  <!-- Saj√°t poz√≠ci√≥ gomb -->
  <button id="locateMeBtn" title="Saj√°t poz√≠ci√≥m"
    style="position: absolute; right: 20px; z-index: 1200; background: none; border: none; padding: 0; width: 48px; height: 48px; box-shadow: 0 4px 15px rgba(49,130,206,0.10); cursor: pointer; display: flex; align-items: center; justify-content: center; bottom: calc(20px + 150px);">
    <svg width="44" height="44" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="blueGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#00c6fb" />
          <stop offset="100%" stop-color="#005bea" />
        </linearGradient>
      </defs>
      <ellipse cx="256" cy="432" rx="192" ry="48" fill="none" stroke="url(#blueGrad)" stroke-width="32" />
      <circle cx="256" cy="120" r="56" fill="none" stroke="url(#blueGrad)" stroke-width="32" />
      <rect x="176" y="200" width="160" height="160" rx="48" fill="none" stroke="url(#blueGrad)" stroke-width="32" />
      <path d="M256 360v72" stroke="url(#blueGrad)" stroke-width="32" stroke-linecap="round" fill="none" />
    </svg>
  </button>

  <script>
    // 1) T√©rk√©p inicializ√°l√°sa
    var map = L.map('map', {
      center: [47.1625, 19.5033],
      zoom: 7,
      zoomControl: true,
      scrollWheelZoom: true,
      doubleClickZoom: true,
      boxZoom: true,
      keyboard: true,
      dragging: true,
      touchZoom: true,
      tap: true,
      tapTolerance: 15,
      bounceAtZoomLimits: false
    });

    // T√©rk√©p r√©tegek
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: '¬© Esri, Maxar, Earthstar Geographics',
      keepBuffer: 100,
      reuseTiles: true
    });

    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors',
      keepBuffer: 100,
      reuseTiles: true
    });

    const boundariesLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: '¬© Esri',
      className: 'boundaries-layer',
      keepBuffer: 100,
      reuseTiles: true
    });

    // Alap√©rtelmezett r√©tegek hozz√°ad√°sa
    let currentMapType = localStorage.getItem('mapType') || 'satellite';
    if (currentMapType === 'satellite') {
      satelliteLayer.addTo(map);
      boundariesLayer.addTo(map);
    } else {
      streetLayer.addTo(map);
    }

    // 2) V√°rosok adatai (n√©v + frekvencia + csatorna + CTCSS)
    const helyek = [
      {nev: "Ajka", freq: "446.16875 MHz", ctcss: "14 (107.2 Hz)", csatorna: 14},
      {nev: "B√°bolna", freq: "446.05625 MHz", ctcss: "13 (103.5 Hz)", csatorna: 5},
      {nev: "Balatonf√ºred", freq: "446.11875 MHz", ctcss: "12 (100.0 Hz)", csatorna: 10},
      {nev: "Eger", freq: "446.15625 MHz", ctcss: "16 (114.8 Hz)", csatorna: 13},
      {nev: "Istenmezeje", freq: "446.11875 MHz", ctcss: "4 (77.0 Hz)", csatorna: 10},
      {nev: "Kerepes", freq: "446.01875 MHz", ctcss: "12 (100.0 Hz)", csatorna: 2},
      {nev: "Keszthely", freq: "446.08125 MHz", ctcss: "22 (141.3 Hz)", csatorna: 7},
      {nev: "Verseg", freq: "446.00625 MHz", ctcss: "21 (136.5 Hz)", csatorna: 1},
      {nev: "Kiskunhalas", freq: "446.10625 MHz", ctcss: "12 (100.0 Hz)", csatorna: 9},
      {nev: "Lajosmizse", freq: "446.04375 MHz", ctcss: "16 (114.8 Hz)", csatorna: 4},
      {nev: "Leps√©ny", freq: "446.15625 MHz", ctcss: "14 (107.2 Hz)", csatorna: 13},
      {nev: "M√°t√©szalka", freq: "446.16875 MHz", ctcss: "13 (103.5 Hz)", csatorna: 14},
      {nev: "P√©cs", freq: "446.18125 MHz", ctcss: "8 (88.5 Hz)", csatorna: 15},
      {nev: "P√©terv√°s√°ra", freq: "446.03125 MHz", ctcss: "13 (103.5 Hz)", csatorna: 3},
      {nev: "Pom√°z", freq: "446.16875 MHz", ctcss: "12 (100.0 Hz)", csatorna: 14},
      {nev: "Salg√≥tarj√°n", freq: "446.16875 MHz", ctcss: "16 (114.8 Hz)", csatorna: 14},
      {nev: "S√°toralja√∫jhely", freq: "446.14375 MHz", ctcss: "177.3 Hz", csatorna: 12},
      {nev: "Szarvas", freq: "446.04375 MHz", ctcss: "12 (100.0 Hz)", csatorna: 4},
      {nev: "Sopron", freq: "446.11875 MHz", ctcss: "10 (94.8 Hz)", csatorna: 10},
      {nev: "Sz√©kesfeh√©rv√°r", freq: "446.06875 MHz", ctcss: "12 (100.0 Hz)", csatorna: 6},
      {nev: "Zalaegerszeg", freq: "446.05625 MHz", ctcss: "12 (100.0 Hz)", csatorna: 5},
      {nev: "Zalaegerszeg 2", freq: "446.14375 MHz", ctcss: "206.5 Hz", csatorna: 12},
      {nev: "Tam√°si", freq: "446.14375 MHz", ctcss: "3 (74.4 Hz)", csatorna: 12},
      {nev: "Tapolca", freq: "446.09375 MHz", ctcss: "13 (103.5 Hz)", csatorna: 8},
      {nev: "√örk√∫t", freq: "446.13125 MHz", ctcss: "32 (203.5 Hz)", csatorna: 11},
      {nev: "√örhida", freq: "446.08125 MHz", ctcss: "12 (100.0 Hz)", csatorna: 7},
      {nev: "√úr√∂m (R√≥ka-hegy)", freq: "446.01875 MHz", ctcss: "7 (85.4 Hz)", csatorna: 2},
      {nev: "√ìcsa", freq: "446.19375 MHz", ctcss: "12 (100.0 Hz)", csatorna: 16}
    ];

    // 3) Geok√≥dol√≥ f√ºggv√©ny
    async function geocode(city) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city + ', Magyarorsz√°g')}`;
      const res = await fetch(url, {
        headers: {'User-Agent': 'papagaj-terkep/1.0 (+https://example.com)'}
      });
      const data = await res.json();
      if (data && data.length) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } else {
        console.warn(`${city} geok√≥dol√°sa nem siker√ºlt.`);
        return null;
      }
    }

    // 4) Egyedi ikon
    const customIcon = L.divIcon({
      className: 'custom-marker',
      html: `
      <div style="
        background: linear-gradient(135deg,#667eea,#764ba2);
        width:24px; height:24px; border-radius:50%; border:4px solid #fff;
        box-shadow:0 4px 15px rgba(0,0,0,0.3);
        position:relative;
      ">
        <div style="
          position:absolute; top:50%; left:50%;
          transform:translate(-50%,-50%); font-size:12px;
        ">üì°</div>
      </div>
    `,
      iconSize: [24, 24],
      iconAnchor: [12, 24]
    });

    // 5) Marker‚Äëek hozz√°ad√°sa fix koordin√°t√°kkal
    let markers = [];
    const koordinatak = [
      [47.103, 17.552], // Ajka
      [47.635, 17.985], // B√°bolna
      [46.960, 17.880], // Balatonf√ºred
      [47.902, 20.377], // Eger
      [47.963, 20.147], // Istenmezeje
      [47.528, 19.319], // Kerepes
      [46.770, 17.250], // Keszthely
      [47.665, 19.540], // Verseg
      [46.430, 19.490], // Kiskunhalas
      [47.000, 19.600], // Lajosmizse
      [46.99310, 18.2456], // Leps√©ny
      [47.950, 22.320], // M√°t√©szalka
      [46.072, 18.233], // P√©cs
      [48.000, 20.100], // P√©terv√°s√°ra
      [47.631, 19.023], // Pom√°z
      [48.100, 19.800], // Salg√≥tarj√°n
      [48.400, 21.650], // S√°toralja√∫jhely
      [46.860, 20.550], // Szarvas
      [47.685, 16.590], // Sopron
      [47.188, 18.410], // Sz√©kesfeh√©rv√°r
      [46.850, 16.850], // Zalaegerszeg
      [46.860, 16.840], // Zalaegerszeg 2
      [46.630, 18.280], // Tam√°si
      [46.880, 17.440], // Tapolca
      [47.080, 17.640], // √örk√∫t
      [47.12989001056956, 18.33217273586016], // √örhida - pontos
      [47.600, 19.030], // √úr√∂m (R√≥ka-hegy)
      [47.283, 19.233]  // √ìcsa
    ];

    helyek.forEach((hely, index) => {
      const coords = koordinatak[index];
      const marker = L.marker(coords, {icon: customIcon}).addTo(map);
      const popup = `
        <div class="custom-popup">
          <h3>ü¶ú ${hely.nev}</h3>
          <p><strong>üì° Csatorna:</strong> ${hely.csatorna} (${hely.freq})</p>
          <p><strong>üîä CTCSS:</strong> ${hely.ctcss}</p>
        </div>
      `;
      marker.bindPopup(popup);
      markers.push(marker);
    });

    // 6) Keres√©s kezel√©se
    const input = document.getElementById('searchInput');
    const btn = document.getElementById('clearSearch');

    function performSearch() {
      const term = input.value.toLowerCase();
      let found = false;
      markers.forEach((m, i) => {
        const h = helyek[i];
        const text = `${h.nev} ${h.freq} ${h.ctcss} ${h.csatorna}`.toLowerCase();
        if (text.includes(term)) {
          m.setOpacity(1);
          m.setZIndexOffset(1000);
          found = true;
        } else {
          m.setOpacity(0.3);
          m.setZIndexOffset(0);
        }
      });
      btn.style.display = term ? 'block' : 'none';
    }

    input.addEventListener('input', performSearch);
    btn.addEventListener('click', () => {
      input.value = '';
      markers.forEach(m => {
        m.setOpacity(1);
        m.setZIndexOffset(0);
      });
      btn.style.display = 'none';
    });

    // 7) T√©mav√°lt√≥ funkcionalit√°s
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'dark';
    
    function setTheme(theme) {
      if (theme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        themeToggle.textContent = '‚òÄÔ∏è';
      } else {
        document.documentElement.removeAttribute('data-theme');
        themeToggle.textContent = 'üåô';
      }
      localStorage.setItem('theme', theme);
    }
    
    setTheme(savedTheme);
    
    themeToggle.addEventListener('click', () => {
      const currentTheme = localStorage.getItem('theme') || 'dark';
      setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    });

    // 8) T√©rk√©p t√≠pus v√°lt√≥ funkcionalit√°s
    const mapToggle = document.getElementById('mapToggle');
    
    function setMapType(type) {
      if (type === 'street') {
        map.removeLayer(satelliteLayer);
        map.removeLayer(boundariesLayer);
        streetLayer.addTo(map);
        mapToggle.textContent = 'üõ∞Ô∏è';
        mapToggle.title = 'V√°lt√°s m≈±holdas n√©zetre';
      } else {
        map.removeLayer(streetLayer);
        satelliteLayer.addTo(map);
        boundariesLayer.addTo(map);
        mapToggle.textContent = 'üó∫Ô∏è';
        mapToggle.title = 'V√°lt√°s utcat√©rk√©pre';
      }
      localStorage.setItem('mapType', type);
    }
    
    // Kezdeti √°llapot be√°ll√≠t√°sa
    setMapType(currentMapType);
    
    mapToggle.addEventListener('click', () => {
      const currentType = localStorage.getItem('mapType') || 'satellite';
      setMapType(currentType === 'satellite' ? 'street' : 'satellite');
    });

    // 9) T√°vols√°g sz√°m√≠t√°s
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // F√∂ld sugara km-ben
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function showNearestChannels(userLat, userLon) {
      const distances = koordinatak.map((coord, index) => ({
        index,
        distance: calculateDistance(userLat, userLon, coord[0], coord[1]),
        data: helyek[index]
      }));
      
      distances.sort((a, b) => a.distance - b.distance);
      
      const distancePanel = document.getElementById('distancePanel');
      const distanceList = document.getElementById('distanceList');
      
      distanceList.innerHTML = distances.slice(0, 5).map(item => `
        <div style="margin-bottom: 8px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; cursor: pointer;" 
             onclick="map.setView([${koordinatak[item.index][0]}, ${koordinatak[item.index][1]}], 12); markers[${item.index}].openPopup();">
          <strong>${item.data.nev}</strong><br>
          <small>üìè ${item.distance.toFixed(1)} km | üì° Cs.${item.data.csatorna} (${item.data.freq})</small>
        </div>
      `).join('');
      
      distancePanel.style.display = 'block';
    }

    // 10) Finom anim√°ci√≥
    setTimeout(() => document.body.style.opacity = '1', 100);

    // Saj√°t poz√≠ci√≥ megjelen√≠t√©se - t√∂bbf√©le m√≥dszerrel
    const locateBtn = document.getElementById('locateMeBtn');
    let userMarker = null;
    
    // IP-alap√∫ helymeghat√°roz√°s (fallback megold√°s)
    async function getLocationByIP() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        if (data.latitude && data.longitude) {
          return {
            latitude: data.latitude,
            longitude: data.longitude,
            city: data.city,
            country: data.country_name,
            accuracy: 'city' // IP-alap√∫, kev√©sb√© pontos
          };
        }
      } catch (error) {
        console.warn('IP-alap√∫ helymeghat√°roz√°s sikertelen:', error);
      }
      return null;
    }
    
    // K√∂z√∂s f√ºggv√©ny a poz√≠ci√≥ megjelen√≠t√©s√©hez
    function showUserLocation(lat, lon, accuracy = 'gps', city = '') {
      if (userMarker) {
        map.removeLayer(userMarker);
      }
      
      // K√ºl√∂nb√∂z≈ë ikonok a pontoss√°g alapj√°n
      const iconColor = accuracy === 'gps' ? '#e53e3e' : '#ff9500';
      const iconText = accuracy === 'gps' ? 'üìç' : 'üåê';
      
      userMarker = L.marker([lat, lon], {
        icon: L.divIcon({
          className: 'custom-marker',
          html: `<svg width="38" height="48" viewBox="0 0 38 48" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 2px 8px ${iconColor}88);">
            <path d="M19 0C9 0 1 8.1 1 18.1c0 10.2 16.1 28.7 16.8 29.5.7.8 1.7.8 2.4 0C20.9 46.8 37 28.3 37 18.1 37 8.1 29 0 19 0z" fill="${iconColor}" stroke="#fff" stroke-width="2"/>
            <circle cx="19" cy="18" r="8" fill="#fff"/>
            <text x="19" y="23" text-anchor="middle" font-size="12">${iconText}</text>
          </svg>`,
          iconSize: [38, 48],
          iconAnchor: [19, 48]
        })
      }).addTo(map);
      
      // Popup hozz√°ad√°sa
      const accuracyText = accuracy === 'gps' ? 'Pontos GPS poz√≠ci√≥' : `Hozz√°vet≈ëleges poz√≠ci√≥ (${city})`;
      userMarker.bindPopup(`
        <div class="custom-popup">
          <h3>üìç Az √ñn poz√≠ci√≥ja</h3>
          <p><strong>Pontoss√°g:</strong> ${accuracyText}</p>
        </div>
      `).openPopup();
      
      map.setView([lat, lon], accuracy === 'gps' ? 13 : 10, {animate: true});
      
      // T√°vols√°g sz√°m√≠t√°s megjelen√≠t√©se
      showNearestChannels(lat, lon);
      
      // Legk√∂zelebbi marker keres√©se
      let minDist = Infinity;
      let closestIdx = -1;
      koordinatak.forEach((coord, idx) => {
        const dLat = (coord[0] - lat) * Math.PI / 180;
        const dLon = (coord[1] - lon) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat * Math.PI / 180) * Math.cos(coord[0] * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const dist = 6371 * c;
        if (dist < minDist) {minDist = dist; closestIdx = idx;}
      });
      
      // Kiemel√©s: popup nyit√°s, marker nagy√≠t√°s
      markers.forEach((m, i) => {
        if (i === closestIdx) {
          m.setZIndexOffset(2000);
          m.setIcon(L.divIcon({
            className: 'custom-marker',
            html: `<div style="background: linear-gradient(135deg,#ffd600,#3182ce); width:36px; height:36px; border-radius:50%; border:5px solid #fff200; box-shadow:0 6px 20px rgba(49,130,206,0.5); position:relative; display:flex; align-items:center; justify-content:center;"><div style=\"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:18px; color:#3182ce; font-weight:bold; text-shadow:0 2px 8px #fff200,0 0 2px #000;\">üì°</div></div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 36]
          }));
          setTimeout(() => m.openPopup(), 1000);
        } else {
          m.setZIndexOffset(0);
          m.setIcon(customIcon);
        }
      });
    }
    
    locateBtn.addEventListener('click', async () => {
      locateBtn.disabled = true;
      locateBtn.style.opacity = 0.6;
      
      // El≈ësz√∂r GPS-t pr√≥b√°lunk
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            showUserLocation(pos.coords.latitude, pos.coords.longitude, 'gps');
            locateBtn.disabled = false;
            locateBtn.style.opacity = 1;
          },
          async (err) => {
            console.warn('GPS sikertelen, IP-alap√∫ m√≥dszerre v√°lt√°s:', err.message);
            
            // Ha GPS nem m≈±k√∂dik, IP-alap√∫ helymeghat√°roz√°st haszn√°lunk
            const ipLocation = await getLocationByIP();
            if (ipLocation) {
              showUserLocation(ipLocation.latitude, ipLocation.longitude, 'ip', ipLocation.city);
              alert(`üìç Hozz√°vet≈ëleges poz√≠ci√≥ meghat√°rozva IP-c√≠m alapj√°n.\nV√°ros: ${ipLocation.city}, ${ipLocation.country}\n\nüí° Tipp: Enged√©lyezd a GPS-t a pontosabb helymeghat√°roz√°shoz.`);
            } else {
              alert('‚ùå Nem siker√ºlt meghat√°rozni a poz√≠ci√≥t.\n\nüîß Pr√≥b√°lkoz√°sok:\n‚Ä¢ GPS helymeghat√°roz√°s\n‚Ä¢ IP-alap√∫ helymeghat√°roz√°s\n\nMind a k√©t m√≥dszer sikertelen volt.');
            }
            locateBtn.disabled = false;
            locateBtn.style.opacity = 1;
          },
          {enableHighAccuracy: true, timeout: 8000, maximumAge: 300000}
        );
      } else {
        // Ha nincs GPS t√°mogat√°s, r√∂gt√∂n IP-alap√∫ m√≥dszert haszn√°lunk
        const ipLocation = await getLocationByIP();
        if (ipLocation) {
          showUserLocation(ipLocation.latitude, ipLocation.longitude, 'ip', ipLocation.city);
          alert(`üìç Poz√≠ci√≥ meghat√°rozva IP-c√≠m alapj√°n.\nV√°ros: ${ipLocation.city}, ${ipLocation.country}\n\nüí° Ez a b√∂ng√©sz≈ë nem t√°mogatja a GPS helymeghat√°roz√°st.`);
        } else {
          alert('‚ùå A helymeghat√°roz√°s nem t√°mogatott √©s az IP-alap√∫ m√≥dszer sem m≈±k√∂dik.');
        }
        locateBtn.disabled = false;
        locateBtn.style.opacity = 1;
      }
    });
  </script>

</body>

</html>
